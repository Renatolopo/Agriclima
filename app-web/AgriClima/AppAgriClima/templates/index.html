{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriClima</title>
    <link rel="stylesheet" type="text/css" href="{% static 'css/index.css' %}">
    <link rel="stylesheet" href="https://js.arcgis.com/4.25/esri/themes/light/main.css">
</head>
<body>

    <div class="container">
        <div class="navbar">
            <h1 class="navbar-brand">AgriClima</h1>
            <ul class="navbar-menu">
                <li><a href="#">Home</a></li>
                <li><a href="#">Sobre</a></li>
                <li><a href="#">Documentação</a></li>
            </ul>
        </div>
    
        <div class="content">
            <!-- Conteúdo da página aqui -->
            <h1>Séries Históricas de Estações</h1>
            <p id="description">Selecione uma estação no mapa abaixo para fazer download</p>
        </div>

        <div id="map-container">
            <div id="map"></div>
            <div id="modal-overlay">
                <div class="form-modal">
                    <h2>Selecione a Estação</h2>
                    <div class="search-mode-buttons">
                        <button id="mode1-btn" class="active" onclick="setSearchMode(1)">Busca padrão</button>
                        <button id="mode2-btn" onclick="setSearchMode(2)">Busca por Coordenadas</button>
                    </div>
                    <div id="form1">
                        <form id="station-form" action="#" method="post">
                            {% csrf_token %}
                            <div class="form-group">
                                <label for="nome-estacao">Nome da Estação</label>
                                <input type="text" id="nome-estacao" name="nome-estacao" placeholder="Digite o nome da Estação" required>
                            </div>
                            <div class="form-group">
                                <label for="cod-estacao">Código da Estação</label>
                                <input type="text" id="cod-estacao" name="cod-estacao" placeholder="Digite o código da Estação" required>
                            </div>
                            <div class="form-group">
                                <input type="submit" value="Buscar">
                            </div>
                        </form>
                    </div>
                    <div id="form2" style="display: none;">
                        <form id="search-coordinates-form" action="#" method="post" onsubmit="return findNearestStations(event)">
                            <div class="form-group">
                                <label for="latitude">Latitude</label>
                                <input type="text" id="latitude" name="latitude" placeholder="Digite a latitude" required>
                            </div>
                            <div class="form-group">
                                <label for="longitude">Longitude</label>
                                <input type="text" id="longitude" name="longitude" placeholder="Digite a longitude" required>
                            </div>
                            <div class="form-group">
                                <input type="submit" value="Buscar">
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Modal para exibir o arquivo CSV -->
            <div id="csv-modal" style="display: none;">
                <div class="modal-content">
                    <span class="close" onclick="closeCsvModal()">&times;</span>
                    <h2>Arquivo CSV</h2>
                    <p id="csv-file-path"></p>
                    <button id="download-csv-btn">Baixar CSV</button>
                    <button id="close-modal-btn" onclick="closeCsvModal()">Fechar</button>
                </div>
            </div>
           


        </div>

        



        <!-- Modal para exibir as estações mais próximas -->
       
        <div id="nearest-stations-modal" style="display: none;">
            <div class="modal-content">
                <span class="close" onclick="closeModal()">&times;</span>
                <h2>Estações Mais Próximas</h2>
                <div class="table-container">
                    <table id="nearest-stations-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="select-all-checkbox"></th>
                                <th>Nome</th>
                                <th>Código</th>
                                <th>Fonte</th>
                                <th>Latitude</th>
                                <th>Longitude</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Esta área será preenchida dinamicamente -->
                        </tbody>
                    </table>
                </div>
                <button id="download-selected-stations" onclick="downloadSelectedStations()">Baixar Selecionados</button>
            </div>
        </div>

    </div>


    



    <!-- Leaflet.js CDN -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    
    <!-- PapaParse.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <!-- Mapa -->
    <script type="text/javascript" src = "{% static 'js/mapa.js' %}" ></script>

    <!-- Script para lidar com o formulário e modal -->
    <script>
            document.getElementById('station-form').addEventListener('submit', function(event) {
            event.preventDefault();

            var formData = new FormData(this);
            fetch('{% url "download_station_data" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('csv-file-path').textContent = data.file_name;
                    document.getElementById('download-csv-btn').onclick = function() {
                        window.location.href = data.file_path;
                    };
                    document.getElementById('download-csv-btn').style.display = 'inline-block';
                    document.getElementById('close-modal-btn').style.display = 'none';
                    document.getElementById('csv-modal').style.display = 'block';
                } else {
                    document.getElementById('csv-file-path').textContent = data.error;
                    document.getElementById('download-csv-btn').style.display = 'none';
                    document.getElementById('close-modal-btn').style.display = 'inline-block';
                    document.getElementById('csv-modal').style.display = 'block';
                }
            })
            .catch(error => {
                alert('Erro: ' + error);
            });
        });

        function closeCsvModal() {
            document.getElementById('csv-modal').style.display = 'none';
        }
    </script>



</body>
</html>
